<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SQL Server XML | dataGriff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Overview
What is XML? What is its structure? What is well-formed XML?
Demonstrate some XQuery
Generate some test data for dogs entering kennels in a table
Show XML FOR functionality
Create XML schema">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL Server XML">
<meta property="og:url" content="www.datagriff.com/2018/05/SQLServerXML/index.html">
<meta property="og:site_name" content="dataGriff">
<meta property="og:description" content="Overview
What is XML? What is its structure? What is well-formed XML?
Demonstrate some XQuery
Generate some test data for dogs entering kennels in a table
Show XML FOR functionality
Create XML schema">
<meta property="og:updated_time" content="2018-05-07T15:33:10.022Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SQL Server XML">
<meta name="twitter:description" content="Overview
What is XML? What is its structure? What is well-formed XML?
Demonstrate some XQuery
Generate some test data for dogs entering kennels in a table
Show XML FOR functionality
Create XML schema">
  
    <link rel="alternate" href="/atom.xml" title="dataGriff" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">dataGriff</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">A blog about data from a guy named Griff</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="www.datagriff.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-SQLServerXML" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/SQLServerXML/" class="article-date">
  <time datetime="2018-05-07T16:10:55.000Z" itemprop="datePublished">2018-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SQL/">SQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SQL Server XML
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><ol>
<li><a href="##1.0-what-is-xML">What is XML? What is its structure? What is well-formed XML?</a></li>
<li><a href="##2.0-xquery">Demonstrate some XQuery</a></li>
<li><a href="##3.0-generate-some-test-data-for-dogs-arriving-in-kennels-in-relational-format">Generate some test data for dogs entering kennels in a table</a></li>
<li><a href="##4.0-show-xml-for-option-functionality">Show XML FOR functionality</a></li>
<li><a href="##5.0-create-xml-schema-using-a-relational-table-structure">Create XML schema from Relational Table</a></li>
<li><a href="##6.0-prove-create-xml-schema-works">Shows XML Schema Validation Works</a></li>
<li><a href="##7.0-import-data-from-xml-files-into-sql-table">Import XML into SQL Table using MERGE</a></li>
<li><a href="##8.0-turning-rows-into-a-csv-group">Create CSV from Row Data</a></li>
</ol>
<h2 id="0-0-Create-Database-and-Schema"><a href="#0-0-Create-Database-and-Schema" class="headerlink" title="0.0 Create Database and Schema"></a>0.0 Create Database and Schema</h2><p>Execute the below on your sql server to create the required database. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> [<span class="keyword">Master</span>]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> SYS.databases <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'XMLDemo'</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> [XMLDemo];</span><br><span class="line"><span class="keyword">END</span> </span><br><span class="line"><span class="keyword">GO</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> [XMLDemo]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">sql</span> <span class="keyword">NVARCHAR</span>(<span class="number">255</span>) = <span class="string">''</span>;</span><br><span class="line">IF SCHEMA_ID('tools') IS NULL</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">Sql</span> = <span class="string">'CREATE SCHEMA [import];'</span>;</span><br><span class="line">EXEC sp_executesql @sql;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<h2 id="1-0-What-is-XML"><a href="#1-0-What-is-XML" class="headerlink" title="1.0 What is XML?"></a>1.0 What is XML?</h2><p>XML stands for Extensible Markup Language. It’s intent is a universal messaging langugage to describe data across<br>multiple environments. It is hierarchical in nature with nodes represented as attributes or elements nested<br>within one another.  </p>
<p>Below you can see some self describing XML which you can execute against your demo database. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">DECLARE</span> @x <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @x = <span class="string">'&lt;?xml version = "1.0"?&gt; </span><br><span class="line">			&lt;!-- This is a comment node--&gt;</span><br><span class="line">			&lt;RootElementNode attribute = "Root element attribute text"&gt;</span><br><span class="line">				&lt;ElementNode&gt;Text node&lt;/ElementNode&gt;</span><br><span class="line">				&lt;ElementNode&gt;Text node 2</span><br><span class="line">				&lt;NestedNode&gt;Nested Text Node&lt;/NestedNode&gt;</span><br><span class="line">				&lt;/ElementNode&gt;</span><br><span class="line">			&lt;/RootElementNode&gt;'</span></span><br><span class="line"><span class="keyword">SELECT</span> @x;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<p>For XML to be well-formed it must have…</p>
<ol>
<li>One of more elements</li>
<li>Only one root element</li>
<li>Elements properly nested within one another and dont overlap </li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span> =</span><br><span class="line">N<span class="string">'&lt;Hospital name = "University Hospital of Wales"&gt;</span><br><span class="line">		&lt;Patient sex="M" name="Bill Withers" age="40"&gt;</span><br><span class="line">			&lt;Diagnosis&gt;Diabetes&lt;/Diagnosis&gt;</span><br><span class="line">			&lt;AdmissionDate&gt;01-10-2014&lt;/AdmissionDate&gt;</span><br><span class="line">		&lt;/Patient&gt;</span><br><span class="line">		&lt;Patient sex="F" name="April O&amp;apos;Neil" age="32"&gt;</span><br><span class="line">			&lt;Diagnosis&gt;Broken Hip&lt;/Diagnosis&gt;</span><br><span class="line">			&lt;AdmissionDate&gt;15-12-2014&lt;/AdmissionDate&gt;</span><br><span class="line">		&lt;/Patient&gt;</span><br><span class="line">		&lt;Patient sex="M" name="Bruce Wayne" age="38"&gt;</span><br><span class="line">			&lt;Diagnosis&gt;Cholera&lt;/Diagnosis&gt;</span><br><span class="line">			&lt;AdmissionDate&gt;10-01-2015&lt;/AdmissionDate&gt;</span><br><span class="line">		&lt;/Patient&gt;</span><br><span class="line">	&lt;/Hospital&gt;'</span>;</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span>;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<p>Non-Well Formed XML must still follow these rules but it doesnt have to have one root node<br>Below is an XML fragment. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span> =</span><br><span class="line">		N<span class="string">'&lt;Patient sex="M" name="Bill Withers" age="40"&gt;</span><br><span class="line">			&lt;Diagnosis&gt;Diabetes&lt;/Diagnosis&gt;</span><br><span class="line">			&lt;AdmissionDate&gt;01-10-2014&lt;/AdmissionDate&gt;</span><br><span class="line">		&lt;/Patient&gt;</span><br><span class="line">		&lt;Patient sex="F" name="April O&amp;apos;Neil" age="32"&gt;</span><br><span class="line">			&lt;Diagnosis&gt;Broken Hip&lt;/Diagnosis&gt;</span><br><span class="line">			&lt;AdmissionDate&gt;15-12-2014&lt;/AdmissionDate&gt;</span><br><span class="line">		&lt;/Patient&gt;</span><br><span class="line">		&lt;Patient sex="M" name="Bruce Wayne" age="38"&gt;</span><br><span class="line">			&lt;Diagnosis&gt;Cholera&lt;/Diagnosis&gt;</span><br><span class="line">			&lt;AdmissionDate&gt;10-01-2015&lt;/AdmissionDate&gt;</span><br><span class="line">		&lt;/Patient&gt;'</span>;</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span>;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<h2 id="2-0-XQuery"><a href="#2-0-XQuery" class="headerlink" title="2.0 XQuery"></a>2.0 XQuery</h2><p>You can query XML directly using XQuery, there are four main functions:</p>
<ol>
<li><strong>Query()</strong> Obtain sections of XML you require</li>
<li><strong>Value()</strong> Obtain single values from XML</li>
<li><strong>Exist()</strong> Determine whether value/element exists (1) or not (0)</li>
<li><strong>Nodes()</strong> Shred XML data into relational format</li>
</ol>
<p>Execute all of the code below on the XMLDemo database and take a look at the outputs. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO</span><br><span class="line">PRINT '2.1 <span class="keyword">Create</span> an <span class="keyword">XML</span> <span class="keyword">variable</span> <span class="keyword">to</span> <span class="keyword">Query</span><span class="string">';</span><br><span class="line">DECLARE @xml XML =</span><br><span class="line">N'</span>&lt;Kennel <span class="keyword">name</span> = <span class="string">"Coedely"</span>&gt;</span><br><span class="line">		&lt;Dog sex=<span class="string">"M"</span> <span class="keyword">name</span>=<span class="string">"Harvey"</span> neutered=<span class="string">"true"</span>&gt;</span><br><span class="line">			&lt;Breed&gt;German Shepherd&lt;/Breed&gt;</span><br><span class="line">			&lt;KennelArrivalDate&gt;<span class="number">01</span><span class="number">-10</span><span class="number">-2014</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">		&lt;/Dog&gt;</span><br><span class="line">		&lt;Dog sex=<span class="string">"F"</span> <span class="keyword">name</span>=<span class="string">"Lucy"</span> neutered=<span class="string">"true"</span>&gt;</span><br><span class="line">			&lt;Breed&gt;Labrador&lt;/Breed&gt;</span><br><span class="line">			&lt;KennelArrivalDate&gt;<span class="number">15</span><span class="number">-12</span><span class="number">-2014</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">		&lt;/Dog&gt;</span><br><span class="line">		&lt;Dog sex=<span class="string">"M"</span> <span class="keyword">name</span>=<span class="string">"Fudge"</span> neutered=<span class="string">"false"</span>&gt;</span><br><span class="line">			&lt;Breed&gt;American Bulldog&lt;/Breed&gt;</span><br><span class="line">			&lt;KennelArrivalDate&gt;<span class="number">10</span><span class="number">-01</span><span class="number">-2015</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">		&lt;/Dog&gt;</span><br><span class="line">	&lt;/Kennel&gt;<span class="string">';</span><br><span class="line"></span><br><span class="line">SELECT @xml AS XMLtoQuery;</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">2.1</span><span class="number">.1</span> <span class="keyword">Query</span>(): <span class="keyword">Get</span> dogs<span class="string">';</span><br><span class="line">SELECT [QueryDogs] =  @xml.query(N'</span>/Kennel/Dog<span class="string">');</span><br><span class="line">PRINT '</span><span class="number">2.1</span><span class="number">.2</span> <span class="keyword">Query</span>(): <span class="keyword">Get</span> dog breeds <span class="string">';</span><br><span class="line">SELECT [QueryDogBreeds] =  @xml.query(N'</span>/Kennel/Dog/Breed<span class="string">');</span><br><span class="line">PRINT '</span><span class="number">2.1</span><span class="number">.3</span> <span class="keyword">Query</span>(): <span class="keyword">Get</span> dog named Harvey<span class="string">';</span><br><span class="line">SELECT [QueryDogNamedHarvey] =  @xml.query(N'</span>/Kennel/Dog[@<span class="keyword">name</span>=<span class="string">"Harvey"</span>]<span class="string">');</span><br><span class="line">PRINT '</span><span class="number">2.2</span> <span class="keyword">Value</span>(): <span class="keyword">Get</span> Breed <span class="keyword">where</span> dog named fudge<span class="string">';</span><br><span class="line">SELECT [ValueFudgeBreed] =  @xml.value(N'</span>(/Kennel/Dog[@<span class="keyword">name</span>=<span class="string">"Fudge"</span>]/Breed)[<span class="number">1</span>]<span class="string">', N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">');</span><br><span class="line">PRINT '</span><span class="number">2.3</span> Exist():  <span class="keyword">Using</span> Exist <span class="keyword">Function</span> <span class="keyword">in</span> <span class="keyword">CASE</span><span class="string">';</span><br><span class="line">SELECT [ExistLucy] =  CASE @xml.exist</span><br><span class="line">(</span><br><span class="line">N'</span>/Kennel/Dog[@<span class="keyword">name</span>=<span class="string">"Lucy"</span>]<span class="string">'</span><br><span class="line">)</span><br><span class="line">WHEN 1 THEN N'</span>The kennel has a dog named Lucy<span class="string">'</span><br><span class="line">WHEN 0 THEN N'</span>The kennel does <span class="keyword">not</span> have a dog named Lucy<span class="string">'</span><br><span class="line">END;</span><br><span class="line">PRINT '</span><span class="number">2.4</span> Nodes(); Shred XML Data into Relational Format';</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">col.value(N<span class="string">'./@sex[1]'</span>,N<span class="string">'nvarchar(100)'</span>) <span class="keyword">AS</span> Sex</span><br><span class="line">,col.value(N<span class="string">'./@name[1]'</span>,N<span class="string">'nvarchar(100)'</span>) <span class="keyword">AS</span> <span class="keyword">Name</span></span><br><span class="line">,col.value(N<span class="string">'./@neutered[1]'</span>,N<span class="string">'nvarchar(100)'</span>) <span class="keyword">AS</span> Neutered</span><br><span class="line">,col.value(N<span class="string">'./Breed[1]'</span>,N<span class="string">'nvarchar(100)'</span>) <span class="keyword">AS</span> Breed</span><br><span class="line"><span class="keyword">FROM</span> @xml.nodes(N<span class="string">'//Kennel/*'</span>) Tab(<span class="keyword">Col</span>);</span><br><span class="line"></span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<h2 id="3-0-Generate-some-test-data-for-Dogs-arriving-in-Kennels-in-relational-format"><a href="#3-0-Generate-some-test-data-for-Dogs-arriving-in-Kennels-in-relational-format" class="headerlink" title="3.0 Generate some test data for Dogs arriving in Kennels in relational format"></a>3.0 Generate some test data for Dogs arriving in Kennels in relational format</h2><p>Run the code below on your database so that we can use the table and data in later parts… </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO</span><br><span class="line">PRINT '3.1  <span class="keyword">Drop</span> Dog Kennel Arrival <span class="keyword">table</span> <span class="keyword">if</span> already <span class="keyword">exists</span><span class="string">';</span><br><span class="line">IF OBJECT_ID('</span>import.DogKennelArrival<span class="string">') IS NOT NULL</span><br><span class="line">	DROP TABLE import.DogKennelArrival;</span><br><span class="line">GO </span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">3.2</span>  <span class="keyword">Create</span> Dog Kennel Arrival <span class="keyword">table</span><span class="string">';</span><br><span class="line">CREATE TABLE import.DogKennelArrival</span><br><span class="line">(</span><br><span class="line">[id] INT IDENTITY CONSTRAINT PK_import_DogKennelArrival PRIMARY KEY CLUSTERED </span><br><span class="line">,[FirstInserted] DATETIME2 NOT NULL CONSTRAINT DF_import_DogKennelArrival_FirstInserted DEFAULT SYSUTCDATETIME()</span><br><span class="line">,[LastUpdated] DATETIME2 NOT NULL CONSTRAINT DF_import_DogKennelArrival_LastUpdated DEFAULT SYSUTCDATETIME()</span><br><span class="line">,[DogName] VARCHAR(25) NOT NULL CONSTRAINT UNQ_DogKennelArrival_DogName UNIQUE</span><br><span class="line">,[DogSex] VARCHAR(8) NOT NULL</span><br><span class="line">,[DogNeutered] BIT NOT NULL</span><br><span class="line">,[DogBreed] VARCHAR(50) NOT NULL</span><br><span class="line">,[KennelArrivalDate] DATE NOT NULL</span><br><span class="line">);</span><br><span class="line">GO </span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">3.3</span>  <span class="keyword">Insert</span> dogs <span class="keyword">into</span> kennel arrival <span class="keyword">table</span><span class="string">';</span><br><span class="line">INSERT INTO import.DogKennelArrival</span><br><span class="line">(</span><br><span class="line">[DogName],[DogSex] ,[DogNeutered],[DogBreed] ,[KennelArrivalDate] </span><br><span class="line">)</span><br><span class="line">VALUES ('</span>Harvey<span class="string">','</span>M<span class="string">',1,'</span>German Shepherd<span class="string">','</span><span class="number">01</span>-<span class="keyword">Oct</span><span class="number">-2014</span><span class="string">')</span><br><span class="line">, ('</span>Lucy<span class="string">','</span>F<span class="string">',1,'</span>Labrador<span class="string">','</span><span class="number">15</span>-<span class="built_in">Dec</span><span class="number">-2014</span><span class="string">')</span><br><span class="line">, ('</span>Fudge<span class="string">','</span>M<span class="string">',0,'</span>American Bulldog<span class="string">','</span><span class="number">10</span>-Jan<span class="number">-2015</span><span class="string">');</span><br><span class="line"></span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>
<h2 id="4-0-Show-XML-FOR-Option-Functionality"><a href="#4-0-Show-XML-FOR-Option-Functionality" class="headerlink" title="4.0 Show XML FOR Option Functionality"></a>4.0 Show XML FOR Option Functionality</h2><p><strong>4.1 XML RAW</strong><br>The default for XML RAW is to create a single outer node with the name of row and generate the XML in an attribute-centric format (4.1.1).<br>You can add the keyword Elements to XML RAW to generate the XML in an element-centric format (4.1.2).</p>
<p>Execute the below on the XMLDemo database to see examples of XML RAW. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line">PRINT '4.1 XML Raw';</span><br><span class="line">PRINT '4.1.1 XML Raw Default (attributes)';</span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">xml</span> = (<span class="keyword">SELECT</span> </span><br><span class="line">[DogName],[DogSex] ,[DogNeutered],[DogBreed] ,[KennelArrivalDate] </span><br><span class="line"><span class="keyword">FROM</span> import.DogKennelArrival</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">RAW</span>);</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span> <span class="keyword">AS</span> <span class="string">'XMLRawDefault'</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '4.1.2 XML Raw ElementsXML';</span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">xml</span> = (<span class="keyword">SELECT</span> </span><br><span class="line">[DogName],[DogSex] ,[DogNeutered],[DogBreed] ,[KennelArrivalDate] </span><br><span class="line"><span class="keyword">FROM</span> import.DogKennelArrival</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">RAW</span>, ELEMENTS);</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span> <span class="keyword">AS</span> <span class="string">'XMLRawElements'</span>;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<p><strong>4.2 XML AUTO</strong><br>The default for XML AUTO is to create a single outer node that is the name of the table or alias used and the XML is in an attribute-centric format (4.2.1).<br>You can add the keyword Elements to XML AUTO to generate the XML in an element-centric format (4.2.2).<br>You can add aliases to the table name and columns so that these aliases represent the nodes in the XML.<br>The order of the columns is important in order to get appropriate hierarchical XML.<br>We will be looking at the XML auto capability to generate XML schema later…</p>
<p>Execute the below on the XMLDemo database to see examples of XML AUTO. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line">PRINT '4.2 XML AUTO';</span><br><span class="line">PRINT '4.2.1 XML Auto Default (attributes)';</span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">xml</span> = (<span class="keyword">SELECT</span> </span><br><span class="line">[DogName],[DogSex] ,[DogNeutered],[DogBreed] ,[KennelArrivalDate] </span><br><span class="line"><span class="keyword">FROM</span> import.DogKennelArrival</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">AUTO</span>);</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span> <span class="keyword">AS</span> <span class="string">'XMLAutoDefault'</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '4.2.2 XML Auto Elements'; </span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">xml</span> = (<span class="keyword">SELECT</span> </span><br><span class="line">[DogName],[DogSex] ,[DogNeutered],[DogBreed] ,[KennelArrivalDate] </span><br><span class="line"><span class="keyword">FROM</span> import.DogKennelArrival</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">AUTO</span>, ELEMENTS);</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span> <span class="keyword">AS</span> <span class="string">'XMLAutoElements'</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '4.2.3 XML Auto with Alias'; </span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">xml</span> = (<span class="keyword">SELECT</span> </span><br><span class="line">Dog.[DogName],Dog.[DogSex] ,Dog.[DogNeutered],Dog.[DogBreed] ,Dog.[KennelArrivalDate] </span><br><span class="line"><span class="keyword">FROM</span> import.DogKennelArrival Dog</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">AUTO</span>, ELEMENTS);</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span> <span class="keyword">AS</span> <span class="string">'XMLAutoElementsAliases'</span>;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<p><strong>4.3 XML PATH</strong><br>This is the most customisable of the FOR clauses<br>The default is returning the XML in an element-centric format with the default “row” outer node (4.3.1).<br>You can provide the name of the outer node for each row and the root node (4.3.2).<br>You can force columns to become attributes using @ or cause customised nesting using “/“ in the alias name (4.3.3).</p>
<p>Execute the below on the XMLDemo database to see examples of XML PATH. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line">PRINT '4.3 XML Path';</span><br><span class="line">PRINT '4.3.1 XML Path Default (elements)';</span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">xml</span> = (<span class="keyword">SELECT</span> </span><br><span class="line">[DogName],[DogSex] ,[DogNeutered],[DogBreed] ,[KennelArrivalDate] </span><br><span class="line"><span class="keyword">FROM</span> import.DogKennelArrival</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">PATH</span>);</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span> <span class="keyword">AS</span> <span class="string">'XMLPathDefault'</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '4.3.2 XML Path with Outer Node and Root Param (well-formed XML)';</span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">xml</span> = (<span class="keyword">SELECT</span> </span><br><span class="line">[DogName],[DogSex] ,[DogNeutered],[DogBreed] ,[KennelArrivalDate] </span><br><span class="line"><span class="keyword">FROM</span> import.DogKennelArrival</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">PATH</span>(<span class="string">'Dog'</span>), root(<span class="string">'Kennel'</span>));</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span> <span class="keyword">AS</span> <span class="string">'XMLPathParameters'</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '4.3.3 XML Path with Attributes and Path Specified';</span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">xml</span> <span class="keyword">XML</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">xml</span> = (<span class="keyword">SELECT</span> </span><br><span class="line">[DogName] <span class="keyword">AS</span> <span class="string">'@name'</span>,[DogSex] ,[DogNeutered],[DogBreed] </span><br><span class="line">,[KennelArrivalDate] <span class="keyword">AS</span> <span class="string">'ArrivalDetails/Date'</span></span><br><span class="line"><span class="keyword">FROM</span> import.DogKennelArrival</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">PATH</span>(<span class="string">'Dog'</span>), root(<span class="string">'Kennel'</span>));</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">xml</span> <span class="keyword">AS</span> <span class="string">'XMLPathParametersAndAliases'</span>;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<h2 id="5-0-Create-XML-Schema-using-a-Relational-Table-Structure"><a href="#5-0-Create-XML-Schema-using-a-Relational-Table-Structure" class="headerlink" title="5.0 Create XML Schema using a Relational Table Structure"></a>5.0 Create XML Schema using a Relational Table Structure</h2><p>You can create an XML schema from a relational table (created in part 3) by capturing the schema and then capturing it when creating a schema collection.</p>
<p>Execute the below on the XMLDemo database to create an XML schema from the DogKennelArrival relational table. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line">PRINT '5.1 <span class="keyword">Declare</span> <span class="keyword">schema</span> <span class="keyword">variable</span><span class="string">';</span><br><span class="line">DECLARE @myschema NVARCHAR(MAX);</span><br><span class="line">SET @myschema = N''</span><br><span class="line">PRINT '</span><span class="number">5.2</span> <span class="keyword">Set</span> <span class="keyword">Schema</span> <span class="keyword">Variable</span> <span class="keyword">using</span> <span class="keyword">XML</span> <span class="keyword">AUTO</span>, ELEMENTS <span class="keyword">and</span> <span class="keyword">XMLSCHEMA</span> <span class="keyword">option</span><span class="string">';</span><br><span class="line">SET @myschema = (SELECT </span><br><span class="line">Dog.[DogName],Dog.[DogSex] ,Dog.[DogNeutered],Dog.[DogBreed] ,Dog.[KennelArrivalDate] </span><br><span class="line">FROM import.DogKennelArrival Dog</span><br><span class="line">WHERE 1=0</span><br><span class="line">FOR XML AUTO, ELEMENTS, XMLSCHEMA('</span>DogNameSpace<span class="string">'));</span><br><span class="line">PRINT '</span><span class="number">5.3</span> <span class="keyword">Select</span> the schemas <span class="keyword">as</span> an <span class="keyword">output</span> <span class="keyword">to</span> look <span class="keyword">at</span><span class="string">';</span><br><span class="line">SELECT CAST(@myschema AS XML) AS '</span>XMLSchemaCreated<span class="string">';</span><br><span class="line">PRINT '</span><span class="number">5.4</span> <span class="keyword">Create</span> <span class="keyword">Schema</span> Collection<span class="string">'</span><br><span class="line">CREATE XML SCHEMA COLLECTION import.XMLDogKennelArrival AS @myschema;</span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>
<h2 id="6-0-Prove-Create-XML-Schema-Works"><a href="#6-0-Prove-Create-XML-Schema-Works" class="headerlink" title="6.0 Prove Create XML Schema Works"></a>6.0 Prove Create XML Schema Works</h2><p>The first part of the code below code creates a table using the XML schema created in part 5.<br>It then inserts some XML data into the table column which fits the schema, and succeeds.<br>It then inserts some XML data into the table column which doesn’t fit the schema, and fails.<br>In the second part of the code it attempts to declare an XML variable with the XML schema created in part 5.<br>It then sets the variable to some XML that fits the schema, and succeeds.<br>It then sets the variable to some XML that doesn’t the schema, and fails. </p>
<p>Execute the below on the XMLDemo database to see the validation of the XML schema in action. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO</span><br><span class="line">PRINT '6.1  <span class="keyword">Drop</span> Dog Kennel Arrival <span class="keyword">XML</span> <span class="keyword">table</span> <span class="keyword">if</span> already <span class="keyword">exists</span><span class="string">';</span><br><span class="line">IF OBJECT_ID('</span>import.DogKennelArrivalXML<span class="string">') IS NOT NULL</span><br><span class="line">	DROP TABLE import.DogKennelArrivalXML;</span><br><span class="line">GO </span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">6.2</span>  <span class="keyword">Create</span> Dog Kennel Arrival <span class="keyword">XML</span> <span class="keyword">table</span> <span class="keyword">with</span> <span class="keyword">schema</span> specified <span class="keyword">on</span> <span class="keyword">XML</span> <span class="keyword">Column</span><span class="string">';</span><br><span class="line">CREATE TABLE import.DogKennelArrivalXML</span><br><span class="line">(</span><br><span class="line">[id] INT IDENTITY PRIMARY KEY CLUSTERED</span><br><span class="line">,[FirstInserted] DATETIME NOT NULL DEFAULT GETDATE()</span><br><span class="line">,[LastUpdated] DATETIME NOT NULL DEFAULT GETDATE()</span><br><span class="line">,[XML] XML (import.XMLDogKennelArrival) --here is where we specify the XML schema</span><br><span class="line">);</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">6.3</span> <span class="keyword">Insert</span> Valid <span class="keyword">XML</span> Succesfully<span class="string">';</span><br><span class="line">INSERT INTO import.DogKennelArrivalXML</span><br><span class="line">(</span><br><span class="line">[XML]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">SELECT '</span>&lt;Dog xmlns=<span class="string">"DogNameSpace"</span>&gt;</span><br><span class="line">  &lt;DogName&gt;Harvey&lt;/DogName&gt;</span><br><span class="line">  &lt;DogSex&gt;M&lt;/DogSex&gt;</span><br><span class="line">  &lt;DogNeutered&gt;<span class="number">1</span>&lt;/DogNeutered&gt;</span><br><span class="line">  &lt;DogBreed&gt;German Shepherd&lt;/DogBreed&gt;</span><br><span class="line">  &lt;KennelArrivalDate&gt;<span class="number">2014</span><span class="number">-10</span><span class="number">-01</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">&lt;/Dog&gt;</span><br><span class="line">&lt;Dog xmlns=<span class="string">"DogNameSpace"</span>&gt;</span><br><span class="line">  &lt;DogName&gt;Lucy&lt;/DogName&gt;</span><br><span class="line">  &lt;DogSex&gt;F&lt;/DogSex&gt;</span><br><span class="line">  &lt;DogNeutered&gt;<span class="number">1</span>&lt;/DogNeutered&gt;</span><br><span class="line">  &lt;DogBreed&gt;Labrador&lt;/DogBreed&gt;</span><br><span class="line">  &lt;KennelArrivalDate&gt;<span class="number">2014</span><span class="number">-12</span><span class="number">-15</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">&lt;/Dog&gt;</span><br><span class="line">&lt;Dog xmlns=<span class="string">"DogNameSpace"</span>&gt;</span><br><span class="line">  &lt;DogName&gt;Fudge&lt;/DogName&gt;</span><br><span class="line">  &lt;DogSex&gt;M&lt;/DogSex&gt;</span><br><span class="line">  &lt;DogNeutered&gt;<span class="number">1</span>&lt;/DogNeutered&gt;</span><br><span class="line">  &lt;DogBreed&gt;American Bulldog&lt;/DogBreed&gt;</span><br><span class="line">  &lt;KennelArrivalDate&gt;<span class="number">2015</span><span class="number">-01</span><span class="number">-10</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">&lt;/Dog&gt;<span class="string">';</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">6.3</span> <span class="keyword">Insert</span> Invalid <span class="keyword">XML</span> <span class="keyword">and</span> it fails<span class="string">';</span><br><span class="line">PRINT '</span>It <span class="keyword">is</span> invalid because it has an extra node <span class="keyword">of</span> DogColour <span class="keyword">not</span> defined <span class="keyword">in</span> the <span class="keyword">schema</span><span class="string">';</span><br><span class="line">INSERT INTO import.DogKennelArrivalXML</span><br><span class="line">(</span><br><span class="line">[XML]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">SELECT '</span>&lt;Dog xmlns=<span class="string">"DogNameSpace"</span>&gt;</span><br><span class="line">  &lt;DogName&gt;Harvey&lt;/DogName&gt;</span><br><span class="line">  &lt;DogSex&gt;M&lt;/DogSex&gt;</span><br><span class="line">  &lt;DogColour&gt;Brown&lt;/DogColour&gt;</span><br><span class="line">  &lt;DogNeutered&gt;<span class="number">1</span>&lt;/DogNeutered&gt;</span><br><span class="line">  &lt;DogBreed&gt;German Shepherd&lt;/DogBreed&gt;</span><br><span class="line">  &lt;KennelArrivalDate&gt;<span class="number">2014</span><span class="number">-10</span><span class="number">-01</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">&lt;/Dog&gt;<span class="string">';</span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>
<p>You can see the same behaviour if you declare an XML variable with the schema specified. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">PRINT '6.4 <span class="keyword">Declare</span> <span class="keyword">Variable</span> <span class="keyword">with</span> <span class="keyword">Schema</span> <span class="keyword">Validation</span> <span class="keyword">for</span> Valid <span class="keyword">Data</span> <span class="keyword">and</span> it Works Fine<span class="string">';</span><br><span class="line">DECLARE @xml XML (import.XMLDogKennelArrival) = </span><br><span class="line">N'</span>&lt;Dog xmlns=<span class="string">"DogNameSpace"</span>&gt;</span><br><span class="line">  &lt;DogName&gt;Harvey&lt;/DogName&gt;</span><br><span class="line">  &lt;DogSex&gt;M&lt;/DogSex&gt;</span><br><span class="line">  &lt;DogNeutered&gt;<span class="number">1</span>&lt;/DogNeutered&gt;</span><br><span class="line">  &lt;DogBreed&gt;German Shepherd&lt;/DogBreed&gt;</span><br><span class="line">  &lt;KennelArrivalDate&gt;<span class="number">2014</span><span class="number">-10</span><span class="number">-01</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">&lt;/Dog&gt;</span><br><span class="line">&lt;Dog xmlns=<span class="string">"DogNameSpace"</span>&gt;</span><br><span class="line">  &lt;DogName&gt;Lucy&lt;/DogName&gt;</span><br><span class="line">  &lt;DogSex&gt;F&lt;/DogSex&gt;</span><br><span class="line">  &lt;DogNeutered&gt;<span class="number">1</span>&lt;/DogNeutered&gt;</span><br><span class="line">  &lt;DogBreed&gt;Labrador&lt;/DogBreed&gt;</span><br><span class="line">  &lt;KennelArrivalDate&gt;<span class="number">2014</span><span class="number">-12</span><span class="number">-15</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">&lt;/Dog&gt;</span><br><span class="line">&lt;Dog xmlns=<span class="string">"DogNameSpace"</span>&gt;</span><br><span class="line">  &lt;DogName&gt;Fudge&lt;/DogName&gt;</span><br><span class="line">  &lt;DogSex&gt;M&lt;/DogSex&gt;</span><br><span class="line">  &lt;DogNeutered&gt;<span class="number">1</span>&lt;/DogNeutered&gt;</span><br><span class="line">  &lt;DogBreed&gt;American Bulldog&lt;/DogBreed&gt;</span><br><span class="line">  &lt;KennelArrivalDate&gt;<span class="number">2015</span><span class="number">-01</span><span class="number">-10</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">&lt;/Dog&gt;<span class="string">'</span><br><span class="line">SELECT @xml;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">6.5</span> <span class="keyword">Declare</span> <span class="keyword">Variable</span> <span class="keyword">with</span> <span class="keyword">Schema</span> <span class="keyword">Validation</span> <span class="keyword">for</span> invalid <span class="keyword">data</span> <span class="keyword">and</span> it fails<span class="string">';</span><br><span class="line">PRINT '</span>It <span class="keyword">is</span> invalid because it has an extra node <span class="keyword">of</span> DogColour <span class="keyword">not</span> defined <span class="keyword">in</span> the <span class="keyword">schema</span><span class="string">';</span><br><span class="line">DECLARE @xml XML (import.XMLDogKennelArrival) = </span><br><span class="line">N'</span>&lt;Dog xmlns=<span class="string">"DogNameSpace"</span>&gt;</span><br><span class="line">  &lt;DogName&gt;Harvey&lt;/DogName&gt;</span><br><span class="line">  &lt;DogSex&gt;M&lt;/DogSex&gt;</span><br><span class="line">  &lt;DogColour&gt;Brown&lt;/DogColour&gt;</span><br><span class="line">  &lt;DogNeutered&gt;<span class="number">1</span>&lt;/DogNeutered&gt;</span><br><span class="line">  &lt;DogBreed&gt;German Shepherd&lt;/DogBreed&gt;</span><br><span class="line">  &lt;KennelArrivalDate&gt;<span class="number">2014</span><span class="number">-10</span><span class="number">-01</span>&lt;/KennelArrivalDate&gt;</span><br><span class="line">&lt;/Dog&gt;<span class="string">';</span><br><span class="line">SELECT @xml;</span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>
<h2 id="7-0-Import-Data-from-XML-Files-into-SQL-Table"><a href="#7-0-Import-Data-from-XML-Files-into-SQL-Table" class="headerlink" title="7.0 Import Data from XML Files into SQL Table"></a>7.0 Import Data from XML Files into SQL Table</h2><p>The following code shows examples of inserts, updates and deletes from XML files (see the <a href="https://github.com/griff182uk/XMLSQL/tree/master/XMLImportFiles" target="_blank" rel="external">XMLImportFiles</a> folder in repo) into SQL server.<br><strong>IMPORTANT NOTE:</strong> For this section to work you must have the XMLImportFiles folder locally and the filepath needs to be correct for the XMLImportFiles in the OPENROWSET bit! See notes on each script where the filepath is. </p>
<p>First we’ll clear down our table, as it is this one we’re going to insert into, by executing the below. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> import.DogKennelArrival;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> import.DogKennelArrival;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<p>Below demonstrates first insert of XML data from the file system using CTE generated from nodes() and a simple MERGE.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PRINT '7.1 <span class="keyword">INSERT</span> <span class="keyword">XML</span> <span class="keyword">DATA</span><span class="string">'; </span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.1</span><span class="number">.1</span> <span class="keyword">Set</span> <span class="built_in">Date</span> <span class="keyword">Format</span> <span class="keyword">and</span> <span class="keyword">Declare</span> <span class="keyword">XML</span> <span class="keyword">Variable</span><span class="string">';</span><br><span class="line">SET DATEFORMAT DMY;</span><br><span class="line">DECLARE @xml XML;</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.1</span><span class="number">.2</span> <span class="keyword">Use</span> OPENROWSET <span class="keyword">to</span> <span class="keyword">read</span> <span class="keyword">XML</span> <span class="keyword">file</span> <span class="keyword">from</span> filesystem<span class="string">';</span><br><span class="line">SELECT @xml = BulkColumn</span><br><span class="line">FROM OPENROWSET(BULK '</span>\XMLImportFiles\XML_Dog_INSERT.xml<span class="string">' --change path to your environment</span><br><span class="line">, SINGLE_BLOB) TempXML;</span><br><span class="line"></span><br><span class="line">--SELECT @xml; --Look at XML variable here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.1</span><span class="number">.3</span> Generate CTE <span class="keyword">of</span> <span class="keyword">XML</span> <span class="keyword">Data</span> <span class="keyword">in</span> <span class="keyword">Relational</span> <span class="keyword">Format</span> <span class="keyword">Using</span> Nodes <span class="keyword">Function</span><span class="string">';</span><br><span class="line">;WITH CTE AS</span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">col.value(N'</span>./Sex[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Sex</span><br><span class="line">,col.value(N'</span>./<span class="keyword">Name</span>[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Name</span><br><span class="line">,col.value(N'</span>./Neutered[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Neutered</span><br><span class="line">,col.value(N'</span>./Breed[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Breed</span><br><span class="line">,col.value(N'</span>./KennelArrivalDate[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS KennelArrivalDate</span><br><span class="line">FROM @xml.nodes(N'</span>//Kennel<span class="comment">/*') Tab(Col)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">--SELECT * FROM CTE --Look at CTE output here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '7.1.4 MERGE XML data from CTE into relational table';</span><br><span class="line">MERGE INTO import.DogKennelArrival AS Tgt</span><br><span class="line">USING CTE AS Src ON</span><br><span class="line">src.Name = tgt.DogName</span><br><span class="line">WHEN NOT MATCHED THEN INSERT</span><br><span class="line">(DogName, DogSex, DogNeutered, DogBreed, KennelArrivalDate)</span><br><span class="line">VALUES (Name, Sex, Neutered, Breed, KennelArrivalDate)</span><br><span class="line">WHEN MATCHED AND  </span><br><span class="line">(</span><br><span class="line"> tgt.DogSex &lt;&gt; src.Sex </span><br><span class="line">OR tgt.DogNeutered &lt;&gt;  src.Neutered </span><br><span class="line">OR  tgt.DogBreed &lt;&gt; src.Breed </span><br><span class="line">OR  tgt.KennelArrivalDate &lt;&gt; src.KennelArrivalDate </span><br><span class="line">) THEN UPDATE </span><br><span class="line">SET  tgt.DogSex = src.Sex </span><br><span class="line">, tgt.DogNeutered =  src.Neutered </span><br><span class="line">,  tgt.DogBreed = src.Breed </span><br><span class="line">,  tgt.KennelArrivalDate = src.KennelArrivalDate ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PRINT '7.1.5 Show data successfully MERGED (INSERT) into SQL table';</span><br><span class="line">SELECT * FROM import.DogKennelArrival;</span><br><span class="line"></span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>
<p>Execute the below to demonstrate the update of XML data from file system using CTE generated from nodes() and simple MERGE.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line"></span><br><span class="line">PRINT '7.2 <span class="keyword">UPDATE</span> <span class="keyword">XML</span> <span class="keyword">DATA</span><span class="string">'; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.2</span><span class="number">.1</span> <span class="keyword">Set</span> <span class="built_in">Date</span> <span class="keyword">Format</span> <span class="keyword">and</span> <span class="keyword">Declare</span> <span class="keyword">XML</span> <span class="keyword">Variable</span><span class="string">';</span><br><span class="line">SET DATEFORMAT DMY;</span><br><span class="line">DECLARE @xml XML;</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.2</span><span class="number">.2</span> <span class="keyword">Use</span> OPENROWSET <span class="keyword">to</span> <span class="keyword">read</span> <span class="keyword">XML</span> <span class="keyword">file</span> <span class="keyword">from</span> filesystem<span class="string">';</span><br><span class="line">SELECT @xml = BulkColumn</span><br><span class="line">FROM OPENROWSET(BULK '</span>\XMLImportFiles\XML_Dog_UPDATE.xml<span class="string">'--change path to your environment</span><br><span class="line">, SINGLE_BLOB) TempXML;</span><br><span class="line"></span><br><span class="line">--SELECT @xml; --Look at XML variable here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.2</span><span class="number">.3</span> Generate CTE <span class="keyword">of</span> <span class="keyword">XML</span> <span class="keyword">Data</span> <span class="keyword">in</span> <span class="keyword">Relational</span> <span class="keyword">Format</span> <span class="keyword">Using</span> Nodes <span class="keyword">Function</span><span class="string">';</span><br><span class="line">;WITH CTE AS</span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">col.value(N'</span>./Sex[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Sex</span><br><span class="line">,col.value(N'</span>./<span class="keyword">Name</span>[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Name</span><br><span class="line">,col.value(N'</span>./Neutered[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Neutered</span><br><span class="line">,col.value(N'</span>./Breed[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Breed</span><br><span class="line">,col.value(N'</span>./KennelArrivalDate[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS KennelArrivalDate</span><br><span class="line">FROM @xml.nodes(N'</span>//Kennel<span class="comment">/*') Tab(Col)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">--SELECT * FROM CTE --Look at CTE output here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '7.2.4 MERGE XML data from CTE into relational table';</span><br><span class="line">MERGE INTO import.DogKennelArrival AS Tgt</span><br><span class="line">USING CTE AS Src ON</span><br><span class="line">src.Name = tgt.DogName</span><br><span class="line">WHEN NOT MATCHED THEN INSERT</span><br><span class="line">(DogName, DogSex, DogNeutered, DogBreed, KennelArrivalDate)</span><br><span class="line">VALUES (Name, Sex, Neutered, Breed, KennelArrivalDate)</span><br><span class="line">WHEN MATCHED AND  </span><br><span class="line">(</span><br><span class="line"> tgt.DogSex &lt;&gt; src.Sex </span><br><span class="line">OR tgt.DogNeutered &lt;&gt;  src.Neutered </span><br><span class="line">OR  tgt.DogBreed &lt;&gt; src.Breed </span><br><span class="line">OR  tgt.KennelArrivalDate &lt;&gt; src.KennelArrivalDate </span><br><span class="line">) THEN UPDATE </span><br><span class="line">SET  tgt.DogSex = src.Sex </span><br><span class="line">, tgt.DogNeutered =  src.Neutered </span><br><span class="line">,  tgt.DogBreed = src.Breed </span><br><span class="line">,  tgt.KennelArrivalDate = src.KennelArrivalDate ;</span><br><span class="line"></span><br><span class="line">PRINT '7.2.6 Can see that UPDATES have taken place';</span><br><span class="line">PRINT 'Fudge is now neutered and Lucy is in fact a Golden Retriever!';</span><br><span class="line">SELECT * FROM import.DogKennelArrival;</span><br><span class="line"></span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>
<p>Execute the below to demonstrate delete of XML data from file system using CTE generated from nodes() and simple MERGE.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line">PRINT '7.3 <span class="keyword">DELETE</span> <span class="keyword">XML</span> <span class="keyword">DATA</span> - (<span class="keyword">MERGE</span> <span class="keyword">STATEMENT</span> HAS EXTRA <span class="keyword">DELETE</span> CRITERIA)<span class="string">';</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.3</span><span class="number">.1</span> <span class="keyword">Set</span> <span class="built_in">Date</span> <span class="keyword">Format</span> <span class="keyword">and</span> <span class="keyword">Declare</span> <span class="keyword">XML</span> <span class="keyword">Variable</span><span class="string">';</span><br><span class="line">SET DATEFORMAT DMY;</span><br><span class="line">DECLARE @xml XML;</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.3</span><span class="number">.2</span> <span class="keyword">Use</span> OPENROWSET <span class="keyword">to</span> <span class="keyword">read</span> <span class="keyword">XML</span> <span class="keyword">file</span> <span class="keyword">from</span> filesystem<span class="string">';</span><br><span class="line">SELECT @xml = BulkColumn</span><br><span class="line">FROM OPENROWSET(BULK '</span>\XMLImportFiles\XML_Dog_DELETE.xml<span class="string">'--change path to your environment</span><br><span class="line">, SINGLE_BLOB) TempXML;</span><br><span class="line"></span><br><span class="line">--SELECT @xml; --Look at XML variable here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.3</span><span class="number">.3</span> Generate CTE <span class="keyword">of</span> <span class="keyword">XML</span> <span class="keyword">Data</span> <span class="keyword">in</span> <span class="keyword">Relational</span> <span class="keyword">Format</span> <span class="keyword">Using</span> Nodes <span class="keyword">Function</span><span class="string">';</span><br><span class="line">PRINT '</span>Note: added <span class="keyword">delete</span> <span class="keyword">column</span><span class="string">';</span><br><span class="line">;WITH CTE AS</span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">col.value(N'</span>./Sex[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Sex</span><br><span class="line">,col.value(N'</span>./<span class="keyword">Name</span>[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Name</span><br><span class="line">,col.value(N'</span>./Neutered[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Neutered</span><br><span class="line">,col.value(N'</span>./Breed[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS Breed</span><br><span class="line">,col.value(N'</span>./KennelArrivalDate[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS KennelArrivalDate</span><br><span class="line">,col.value(N'</span>./<span class="keyword">Delete</span>[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS [Delete]</span><br><span class="line">FROM @xml.nodes(N'</span>//Kennel<span class="comment">/*') Tab(Col)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">--SELECT * FROM CTE --Look at CTE output here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '7.3.4 MERGE XML data from CTE into relational table';</span><br><span class="line">MERGE INTO import.DogKennelArrival AS Tgt</span><br><span class="line">USING CTE AS Src ON</span><br><span class="line">src.Name = tgt.DogName</span><br><span class="line">WHEN NOT MATCHED THEN INSERT</span><br><span class="line">(DogName, DogSex, DogNeutered, DogBreed, KennelArrivalDate)</span><br><span class="line">VALUES (Name, Sex, Neutered, Breed, KennelArrivalDate)</span><br><span class="line">WHEN MATCHED AND  </span><br><span class="line">(</span><br><span class="line"> tgt.DogSex &lt;&gt; src.Sex </span><br><span class="line">OR tgt.DogNeutered &lt;&gt;  src.Neutered </span><br><span class="line">OR  tgt.DogBreed &lt;&gt; src.Breed </span><br><span class="line">OR  tgt.KennelArrivalDate &lt;&gt; src.KennelArrivalDate </span><br><span class="line">) THEN UPDATE </span><br><span class="line">SET  tgt.DogSex = src.Sex </span><br><span class="line">, tgt.DogNeutered =  src.Neutered </span><br><span class="line">,  tgt.DogBreed = src.Breed </span><br><span class="line">,  tgt.KennelArrivalDate = src.KennelArrivalDate </span><br><span class="line">WHEN MATCHED AND [Delete] = 'true'</span><br><span class="line">THEN DELETE;</span><br><span class="line"></span><br><span class="line">PRINT '7.3.5 Harvey has been deleted from the Kennel (I''ve taken him home!)';</span><br><span class="line">SELECT * FROM import.DogKennelArrival;</span><br><span class="line"></span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>
<p>Execute the below to demonstrate insert of sparse XML data from file system using CTE generated from nodes() and simple MERGE.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line">PRINT '7.4 <span class="keyword">INSERT</span> <span class="keyword">SPARSE</span> <span class="keyword">XML</span><span class="string">';</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.4</span><span class="number">.1</span> <span class="keyword">Set</span> <span class="built_in">Date</span> <span class="keyword">Format</span> <span class="keyword">and</span> <span class="keyword">Declare</span> <span class="keyword">XML</span> <span class="keyword">Variable</span><span class="string">';</span><br><span class="line">SET DATEFORMAT DMY;</span><br><span class="line">DECLARE @xml XML;</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.4</span><span class="number">.2</span> <span class="keyword">Use</span> OPENROWSET <span class="keyword">to</span> <span class="keyword">read</span> <span class="keyword">XML</span> <span class="keyword">file</span> <span class="keyword">from</span> filesystem<span class="string">'; </span><br><span class="line">SELECT @xml = BulkColumn</span><br><span class="line">FROM OPENROWSET(BULK '</span>\XMLImportFiles\XML_Dog_SPARSE.xml<span class="string">', SINGLE_BLOB) TempXML;</span><br><span class="line"></span><br><span class="line">--SELECT @xml; --Look at XML variable here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">7.4</span><span class="number">.3</span> Generate CTE <span class="keyword">of</span> <span class="keyword">XML</span> <span class="keyword">Data</span> <span class="keyword">in</span> <span class="keyword">Relational</span> <span class="keyword">Format</span> <span class="keyword">Using</span> Nodes <span class="keyword">Function</span><span class="string">';</span><br><span class="line">PRINT '</span>Note: added <span class="keyword">delete</span> <span class="keyword">column</span><span class="string">';</span><br><span class="line">;WITH CTE AS</span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">COALESCE(col.value(N'</span>./Sex[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">'),'') AS Sex</span><br><span class="line">,COALESCE(col.value(N'</span>./<span class="keyword">Name</span>[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">'),'') AS Name</span><br><span class="line">,COALESCE(col.value(N'</span>./Neutered[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">'),'') AS Neutered</span><br><span class="line">,COALESCE(col.value(N'</span>./Breed[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">'),'') AS Breed</span><br><span class="line">,COALESCE(col.value(N'</span>./KennelArrivalDate[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">'),'') AS KennelArrivalDate</span><br><span class="line">,col.value(N'</span>./<span class="keyword">Delete</span>[<span class="number">1</span>]<span class="string">',N'</span><span class="keyword">nvarchar</span>(<span class="number">100</span>)<span class="string">') AS [Delete]</span><br><span class="line">FROM @xml.nodes(N'</span>//Kennel<span class="comment">/*') Tab(Col)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">--SELECT * FROM CTE --Look at CTE output here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '7.4.4 MERGE XML data from CTE into relational table';</span><br><span class="line">MERGE INTO import.DogKennelArrival AS Tgt</span><br><span class="line">USING CTE AS Src ON</span><br><span class="line">src.Name = tgt.DogName</span><br><span class="line">WHEN NOT MATCHED THEN INSERT</span><br><span class="line">(DogName, DogSex, DogNeutered, DogBreed, KennelArrivalDate)</span><br><span class="line">VALUES (Name, Sex, Neutered, Breed, KennelArrivalDate)</span><br><span class="line">WHEN MATCHED AND  </span><br><span class="line">(</span><br><span class="line"> tgt.DogSex &lt;&gt; src.Sex </span><br><span class="line">OR tgt.DogNeutered &lt;&gt;  src.Neutered </span><br><span class="line">OR  tgt.DogBreed &lt;&gt; src.Breed </span><br><span class="line">OR  tgt.KennelArrivalDate &lt;&gt; src.KennelArrivalDate </span><br><span class="line">) THEN UPDATE </span><br><span class="line">SET  tgt.DogSex = src.Sex </span><br><span class="line">, tgt.DogNeutered =  src.Neutered </span><br><span class="line">,  tgt.DogBreed = src.Breed </span><br><span class="line">,  tgt.KennelArrivalDate = src.KennelArrivalDate </span><br><span class="line">WHEN MATCHED AND [Delete] = 'true'</span><br><span class="line">THEN DELETE;</span><br><span class="line"></span><br><span class="line">SELECT * FROM import.DogKennelArrival;</span><br><span class="line"></span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>
<p>Execute the below to demonstrate the addition of a column to the XML data from file system using CTE generated from nodes() and simple MERGE.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line"></span><br><span class="line">PRINT '6.5 Add Extra Field';</span><br><span class="line"></span><br><span class="line">PRINT '6.5.1 Add Extra Column';</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> import.DogKennelArrival</span><br><span class="line"><span class="keyword">ADD</span> DogColour <span class="built_in">VARCHAR</span>(<span class="number">25</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">PRINT '6.5.2 <span class="keyword">Set</span> <span class="built_in">Date</span> <span class="keyword">Format</span> <span class="keyword">and</span> <span class="keyword">Declare</span> <span class="keyword">XML</span> <span class="keyword">Variable</span><span class="string">';</span><br><span class="line">SET DATEFORMAT DMY;</span><br><span class="line">DECLARE @xml XML;</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">6.5</span><span class="number">.3</span> <span class="keyword">Use</span> OPENROWSET <span class="keyword">to</span> <span class="keyword">read</span> <span class="keyword">XML</span> <span class="keyword">file</span> <span class="keyword">from</span> filesystem<span class="string">'; </span><br><span class="line">SELECT @xml = BulkColumn</span><br><span class="line">FROM OPENROWSET(BULK '</span>\XMLImportFiles\XML_Dog_ADDITEM.xml<span class="string">', SINGLE_BLOB) TempXML;</span><br><span class="line"></span><br><span class="line">--SELECT @xml; --Look at XML variable here for debugging if required</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">6.5</span><span class="number">.4</span> Generate CTE <span class="keyword">of</span> <span class="keyword">XML</span> <span class="keyword">Data</span> <span class="keyword">in</span> <span class="keyword">Relational</span> <span class="keyword">Format</span> <span class="keyword">Using</span> Nodes <span class="keyword">Function</span><span class="string">';</span><br><span class="line">--Note: added delete column'</span>;</span><br><span class="line">;WITH CTE AS</span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"><span class="keyword">COALESCE</span>(col.value(N<span class="string">'./Sex[1]'</span>,N<span class="string">'nvarchar(100)'</span>),<span class="string">''</span>) <span class="keyword">AS</span> Sex</span><br><span class="line">,<span class="keyword">COALESCE</span>(col.value(N<span class="string">'./Name[1]'</span>,N<span class="string">'nvarchar(100)'</span>),<span class="string">''</span>) <span class="keyword">AS</span> <span class="keyword">Name</span></span><br><span class="line">,<span class="keyword">COALESCE</span>(col.value(N<span class="string">'./Neutered[1]'</span>,N<span class="string">'nvarchar(100)'</span>),<span class="string">''</span>) <span class="keyword">AS</span> Neutered</span><br><span class="line">,<span class="keyword">COALESCE</span>(col.value(N<span class="string">'./Breed[1]'</span>,N<span class="string">'nvarchar(100)'</span>),<span class="string">''</span>) <span class="keyword">AS</span> Breed</span><br><span class="line">,<span class="keyword">coalesce</span>(col.value(N<span class="string">'./KennelArrivalDate[1]'</span>,N<span class="string">'nvarchar(100)'</span>),<span class="string">''</span>) <span class="keyword">AS</span> KennelArrivalDate</span><br><span class="line">,<span class="keyword">COALESCE</span>(col.value(N<span class="string">'./Colour[1]'</span>,N<span class="string">'nvarchar(100)'</span>),<span class="string">''</span>) <span class="keyword">AS</span> Colour</span><br><span class="line">,col.value(N<span class="string">'./Delete[1]'</span>,N<span class="string">'nvarchar(100)'</span>) <span class="keyword">AS</span> [<span class="keyword">Delete</span>]</span><br><span class="line"><span class="keyword">FROM</span> @xml.nodes(N<span class="string">'//Kennel/*'</span>) Tab(<span class="keyword">Col</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">--SELECT * FROM CTE --Look at CTE output here for debugging if required</span></span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'6.5.6 MERGE XML data from CTE into relational table'</span>;</span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> import.DogKennelArrival <span class="keyword">AS</span> Tgt</span><br><span class="line"><span class="keyword">USING</span> CTE <span class="keyword">AS</span> Src <span class="keyword">ON</span></span><br><span class="line">src.Name = tgt.DogName</span><br><span class="line"><span class="keyword">WHEN</span> <span class="keyword">NOT</span> <span class="keyword">MATCHED</span> <span class="keyword">THEN</span> <span class="keyword">INSERT</span></span><br><span class="line">(DogName, DogSex, DogNeutered, DogBreed, KennelArrivalDate, DogColour)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="keyword">Name</span>, Sex, Neutered, Breed, KennelArrivalDate, Colour)</span><br><span class="line"><span class="keyword">WHEN</span> <span class="keyword">MATCHED</span> <span class="keyword">AND</span>  </span><br><span class="line">(</span><br><span class="line"> tgt.DogSex &lt;&gt; src.Sex </span><br><span class="line"><span class="keyword">OR</span> tgt.DogNeutered &lt;&gt;  src.Neutered </span><br><span class="line"><span class="keyword">OR</span>  tgt.DogBreed &lt;&gt; src.Breed </span><br><span class="line"><span class="keyword">OR</span>  tgt.KennelArrivalDate &lt;&gt; src.KennelArrivalDate </span><br><span class="line"><span class="keyword">OR</span>  tgt.DogColour &lt;&gt; src.Colour </span><br><span class="line">) <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> </span><br><span class="line"><span class="keyword">SET</span>  tgt.DogSex = src.Sex </span><br><span class="line">, tgt.DogNeutered =  src.Neutered </span><br><span class="line">,  tgt.DogBreed = src.Breed </span><br><span class="line">,  tgt.KennelArrivalDate = src.KennelArrivalDate </span><br><span class="line">, tgt.DogColour = src.Colour </span><br><span class="line"><span class="keyword">WHEN</span> <span class="keyword">MATCHED</span> <span class="keyword">AND</span> [<span class="keyword">Delete</span>] = <span class="string">'true'</span></span><br><span class="line"><span class="keyword">THEN</span> <span class="keyword">DELETE</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> import.DogKennelArrival;</span><br><span class="line"></span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<h2 id="8-0-Turning-rows-into-a-csv-group"><a href="#8-0-Turning-rows-into-a-csv-group" class="headerlink" title="8.0 Turning rows into a csv group"></a>8.0 Turning rows into a csv group</h2><p>This is really useful for multiple instances per event, e.g. diagnosis or procedures per an admission).</p>
<p>Execute the code below to see the row based data transform into a comma delimited list on a single row…</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> XMLDemo;</span><br><span class="line">GO </span><br><span class="line">PRINT '8.1 <span class="keyword">Create</span> small demo <span class="keyword">table</span> <span class="keyword">of</span> <span class="keyword">values</span><span class="string">';</span><br><span class="line">DECLARE @Table1 TABLE(AdmissionID INT, Diagnosis VARCHAR(100));</span><br><span class="line">INSERT INTO @Table1 VALUES (1,'</span>Heart <span class="keyword">Failure</span><span class="string">'),(1,'</span>Brain Pain<span class="string">')</span><br><span class="line">,(1,'</span>Leg damage<span class="string">'),(1,'</span>Knee twist<span class="string">'),(1,'</span>Eye bulge<span class="string">')</span><br><span class="line">,(2,'</span>Cholera<span class="string">'),(3,'</span>Tuberculosis<span class="string">'),(2,'</span>Lurgy<span class="string">'),(3,'</span>Spots<span class="string">');</span><br><span class="line">SELECT * FROM @Table1;</span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">8.2</span> Us <span class="keyword">XML</span> <span class="keyword">path</span> <span class="keyword">and</span> <span class="keyword">Stuff</span> <span class="keyword">to</span> <span class="keyword">convert</span> <span class="keyword">into</span> comma <span class="keyword">delimited</span> <span class="keyword">string</span><span class="string">';</span><br><span class="line">SELECT  AdmissionID</span><br><span class="line">       ,STUFF((SELECT '</span>, <span class="string">' + CAST(Diagnosis AS VARCHAR(10)) [text()]</span><br><span class="line">         FROM @Table1 </span><br><span class="line">         WHERE AdmissionID = t.AdmissionID</span><br><span class="line">FOR XML PATH('')),1,1,'')</span><br><span class="line">FROM @Table1 t</span><br><span class="line">GROUP BY AdmissionID;</span></span><br></pre></td></tr></table></figure>
<p>To demonstrate the speed of this, execute the following code, which first generates a million rows of data then performs the same logic as above!</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">PRINT '8.3.1 <span class="keyword">Create</span> tally <span class="keyword">table</span> <span class="keyword">to</span> <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> <span class="keyword">in</span> part <span class="number">2</span><span class="string">';</span><br><span class="line">DECLARE @rows INT = 1000000;</span><br><span class="line"></span><br><span class="line">IF OBJECT_ID('</span>tempdb..#tally<span class="string">') IS NOT NULL</span><br><span class="line">	DROP TABLE #tally;</span><br><span class="line"></span><br><span class="line">WITH cte as </span><br><span class="line">(</span><br><span class="line">	SELECT 1 as n</span><br><span class="line">	UNION ALL</span><br><span class="line">	SELECT n +1</span><br><span class="line">	FROM cte</span><br><span class="line">	WHERE n &lt; @rows</span><br><span class="line">)</span><br><span class="line">SELECT *</span><br><span class="line">	INTO #tally </span><br><span class="line">FROM cte </span><br><span class="line">OPTION (MAXRECURSION 0);  </span><br><span class="line">GO </span><br><span class="line"></span><br><span class="line">PRINT '</span><span class="number">8.3</span><span class="number">.2</span> See <span class="keyword">Rows</span> <span class="keyword">get</span> turned <span class="keyword">to</span> CSV Very Quickly!<span class="string">';</span><br><span class="line">;WITH CTE AS</span><br><span class="line">(</span><br><span class="line">SELECT n AS AdmissionID, Diagnosis FROM #tally</span><br><span class="line">CROSS JOIN  (SELECT '</span>Cough<span class="string">' AS Diagnosis UNION SELECT '</span>Sneeze<span class="string">' UNION SELECT '</span>Hiccups<span class="string">') AS b</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">SELECT  AdmissionID</span><br><span class="line">       ,STUFF((SELECT '</span>, <span class="string">' + CAST(Diagnosis AS VARCHAR(10)) [text()]</span><br><span class="line">         FROM Cte </span><br><span class="line">         WHERE AdmissionID = t.AdmissionID</span><br><span class="line">FOR XML PATH('')),1,1,'')</span><br><span class="line">FROM CTE t</span><br><span class="line">GROUP BY t.AdmissionID;</span><br><span class="line">GO</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="www.datagriff.com/2018/05/SQLServerXML/" data-id="cjgweoogw001z7skaotltv6jn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL/">SQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XML/">XML</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/04/BIML-a-Stage-ETL/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">BIML a Stage ETL</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/05/SQLServerXML/">SQL Server XML</a>
          </li>
        
          <li>
            <a href="/2017/04/BIML-a-Stage-ETL/">BIML a Stage ETL</a>
          </li>
        
          <li>
            <a href="/2016/12/Passing-the-70462-Exam-and-Lessons-Learned/">Passing the 70462 Exam and Lessons Learned</a>
          </li>
        
          <li>
            <a href="/2016/11/SQL-2012-Admin-Exam-12-SQL-Agent-Backup-and-Restore/">SQL 2012 Admin Exam 12 SQL Agent Backup and Restore</a>
          </li>
        
          <li>
            <a href="/2016/11/SQL-2012-Admin-Exam-11-Indexes-and-Concurrency/">SQL 2012 Admin Exam 11 Indexes and Concurrency</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Azure/">Azure</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/BIML/">BIML</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Github/">Github</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Presentation/">Presentation</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL-Administration/">SQL Administration</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Visual-Studio/">Visual Studio</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/">Azure</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BIML/">BIML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blogging/">Blogging</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Command-Line/">Command-Line</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Warehouse/">Data Warehouse</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Exam-70462/">Exam 70462</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Presentation/">Presentation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/">SQL</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-Administration/">SQL Administration</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSDT/">SSDT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSIS/">SSIS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Source-Control/">Source Control</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Starting-Up/">Starting Up</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Team-Services/">Team Services</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Virtual-Machines/">Virtual Machines</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visual-Studio/">Visual Studio</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XML/">XML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YAML/">YAML</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Azure/" style="font-size: 11.43px;">Azure</a> <a href="/tags/BIML/" style="font-size: 10px;">BIML</a> <a href="/tags/Blogging/" style="font-size: 17.14px;">Blogging</a> <a href="/tags/Command-Line/" style="font-size: 10px;">Command-Line</a> <a href="/tags/Data-Warehouse/" style="font-size: 10px;">Data Warehouse</a> <a href="/tags/Exam-70462/" style="font-size: 18.57px;">Exam 70462</a> <a href="/tags/Git/" style="font-size: 15.71px;">Git</a> <a href="/tags/Hexo/" style="font-size: 14.29px;">Hexo</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Presentation/" style="font-size: 10px;">Presentation</a> <a href="/tags/SQL/" style="font-size: 20px;">SQL</a> <a href="/tags/SQL-Administration/" style="font-size: 18.57px;">SQL Administration</a> <a href="/tags/SSDT/" style="font-size: 10px;">SSDT</a> <a href="/tags/SSIS/" style="font-size: 10px;">SSIS</a> <a href="/tags/Source-Control/" style="font-size: 12.86px;">Source Control</a> <a href="/tags/Starting-Up/" style="font-size: 15.71px;">Starting Up</a> <a href="/tags/Team-Services/" style="font-size: 10px;">Team Services</a> <a href="/tags/Virtual-Machines/" style="font-size: 10px;">Virtual Machines</a> <a href="/tags/Visual-Studio/" style="font-size: 11.43px;">Visual Studio</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/YAML/" style="font-size: 10px;">YAML</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Richard Griffiths<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>